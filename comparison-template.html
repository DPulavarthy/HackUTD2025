<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toyota Car Recommendations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #6b6b6b;
            min-height: 100vh;
            color: #333;
        }

        h1 {
            color: #fff;
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 400;
        }

        .subtitle strong {
            color: #fff;
            font-weight: 600;
        }

        .instruction {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 40px;
            font-style: italic;
            font-size: 1em;
        }

        .ai-analysis {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .ai-analysis h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .ai-analysis-content {
            line-height: 1.7;
            color: #555;
            white-space: pre-wrap;
            font-size: 0.95em;
        }

        .section-title {
            text-align: center;
            color: #fff;
            margin: 50px 0 30px 0;
            font-size: 2em;
            font-weight: 600;
        }

        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .car-card {
            background: #fff;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .car-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .car-card.selected {
            border: 3px solid #000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .car-card img {
            width: 100%;
            height: 260px;
            object-fit: cover;
            background: linear-gradient(135deg, #e8e8e8 0%, #f0f0f0 100%);
        }

        .car-card > * {
            padding: 0 25px;
        }

        .car-card img {
            padding: 0;
        }

        .car-card h2 {
            color: #000;
            margin: 20px 0 10px 0;
            font-size: 1.8em;
            font-weight: 600;
            padding: 0 25px;
        }

        .car-card p {
            color: #4a5568;
            line-height: 1.6;
            margin: 6px 0;
            font-size: 1em;
            padding: 0 25px;
        }

        .car-card strong {
            color: #2d3748;
            font-weight: 600;
        }

        .car-links {
            margin: 20px 0 0 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 20px 25px;
            background: #f7fafc;
        }

        .car-card a {
            display: inline-flex;
            align-items: center;
            color: #3182ce;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            z-index: 10;
            position: relative;
            font-size: 0.95em;
        }

        .car-card a:hover {
            color: #2c5aa0;
            transform: translateX(3px);
        }

        .selection-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #000;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease;
            z-index: 100;
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Comparison Modal */
        .comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(107, 107, 107, 0.95);
            z-index: 1000;
            overflow: auto;
            animation: fadeInModal 0.3s ease;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .comparison-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .comparison-content {
            background: #fff;
            width: 95%;
            max-width: 1800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            padding: 40px;
            position: relative;
            animation: slideIn 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 40px;
            cursor: pointer;
            color: #718096;
            transition: all 0.2s ease;
            line-height: 1;
            z-index: 10;
            font-weight: 300;
        }

        .close-btn:hover {
            color: #2d3748;
            transform: scale(1.1);
        }

        .comparison-title {
            text-align: center;
            color: #000;
            font-size: 2em;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }

        .comparison-car {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .comparison-grid:hover .comparison-car {
            opacity: 0.5;
            transform: scale(0.92);
        }

        .comparison-grid .comparison-car:hover {
            opacity: 1 !important;
            transform: scale(1.08) !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            z-index: 100;
        }

        .comparison-car img {
            width: 100%;
            height: 280px;
            object-fit: cover;
            object-position: center;
            border-radius: 12px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #e8e8e8 0%, #f0f0f0 100%);
        }

        .comparison-car h2 {
            margin-bottom: 15px;
            color: #000;
            font-size: 1.7em;
            text-align: center;
            font-weight: 600;
        }

        .comparison-car > p {
            margin: 8px 0;
            color: #4a5568;
            text-align: center;
            font-size: 1em;
            line-height: 1.5;
        }

        .factors-section-title {
            grid-column: 1 / -1;
            text-align: center;
            color: #000;
            font-size: 1.6em;
            margin: 35px 0 25px 0;
            font-weight: 600;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .factor-row {
            padding: 18px;
            margin: 10px 0;
            border-radius: 10px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .factor-row:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .factor-label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.05em;
            text-transform: capitalize;
            display: flex;
            align-items: center;
        }

        .factor-value {
            line-height: 1.6;
            color: #4a5568;
            font-size: 0.95em;
        }

        .good {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .good .factor-label {
            color: #155724;
        }

        .neutral {
            background: #f8f9fa;
            color: #495057;
            border-left-color: #6c757d;
        }

        .poor {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .poor .factor-label {
            color: #721c24;
        }

        /* Legend */
        .legend {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 25px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }

        .legend-color.good {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .legend-color.neutral {
            background: #f8f9fa;
            border: 2px solid #6c757d;
        }

        .legend-color.poor {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .legend-text {
            font-weight: 500;
            color: #4a5568;
        }

        /* Financing Section Styles */
        .financing-section {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .financing-title {
            font-size: 2em;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .financing-subtitle {
            text-align: center;
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .financing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .financing-car {
            background: white;
            padding: 25px;
            border-radius: 15px;
            color: #2d3748;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .financing-grid:hover .financing-car {
            opacity: 0.5;
            transform: scale(0.92);
        }

        .financing-grid .financing-car:hover {
            opacity: 1 !important;
            transform: scale(1.08) !important;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
            z-index: 100;
        }

        .financing-car h3 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .best-deal-box {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .best-deal-title {
            font-size: 1.3em;
            font-weight: 800;
            color: white;
            margin-bottom: 12px;
            text-align: center;
        }

        .best-deal-item {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 0.95em;
        }

        .best-deal-item:last-child {
            margin-bottom: 0;
        }

        .dealer-name {
            color: #667eea;
            font-size: 0.9em;
        }

        .dealer-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .dealer-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .dealer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dealer-name-main {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
        }

        .dealer-distance {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .dealer-address {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .dealer-phone {
            color: #4a5568;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .finance-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .finance-tab {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .tab-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.05em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .credit-tier {
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .credit-tier strong {
            display: block;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .tier-details {
            color: #718096;
            padding-left: 10px;
            line-height: 1.5;
        }

        .price-note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 0.85em;
        }

        .lease-tab {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .lease-tab .tab-title {
            color: white;
            border-bottom-color: white;
        }

        .lease-highlight {
            font-size: 2em;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
        }

        .lease-details {
            text-align: center;
            font-size: 0.9em;
            opacity: 0.95;
            line-height: 1.6;
        }

        .ownership-costs {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #e2e8f0;
        }

        .costs-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .cost-item span {
            color: #718096;
        }

        .cost-item strong {
            color: #2d3748;
            font-weight: 700;
        }

        .cost-item.total-cost {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1em;
            font-weight: 700;
        }

        .cost-item.total-cost span,
        .cost-item.total-cost strong {
            color: white;
        }

        /* Scrollbar styling */
        .comparison-content::-webkit-scrollbar {
            width: 10px;
        }

        .comparison-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .comparison-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .comparison-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .legend {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <h1>üöó Your Toyota Recommendations</h1>
    <p class="subtitle">
        <strong>Top 3 Matching Factors:</strong> <span id="topFactors"></span>
    </p>
    <p class="instruction">
        Click on any 2 cars to compare them side-by-side with detailed analysis
    </p>
    
    <div class="ai-analysis">
        <h2>AI Analysis</h2>
        <div class="ai-analysis-content" id="aiAnalysis"></div>
    </div>
    
    <h2 class="section-title">Recommended Vehicles</h2>
    <div class="car-grid" id="carGrid"></div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal">
        <div class="comparison-content">
            <span class="close-btn" onclick="closeComparison()">&times;</span>
            <h1 class="comparison-title">üîç Vehicle Comparison</h1>
            <div id="comparisonGrid"></div>
        </div>
    </div>

    <script>
        // Data will be injected here
        const carsData = window.CARS_DATA || [];
        const topFactors = window.TOP_FACTORS || [];
        const userSpec = window.USER_SPEC || "";
        const aiAnalysisText = window.AI_ANALYSIS || "";
        
        let selectedCars = [];

        // Initialize the page
        function init() {
            document.getElementById('topFactors').textContent = topFactors.map(f => 
                f.replace(/_/g, ' ').toUpperCase()
            ).join(', ');
            
            document.getElementById('aiAnalysis').innerHTML = aiAnalysisText.replace(/\n/g, '<br>');
            
            renderCars();
        }

        function renderCars() {
            const grid = document.getElementById('carGrid');
            grid.innerHTML = '';
            
            carsData.forEach((car, index) => {
                const card = document.createElement('div');
                card.className = 'car-card';
                card.dataset.carIndex = index;
                card.onclick = (e) => selectCar(index, e);
                
                const imageUrl = `https://cdn.imagin.studio/getImage?customer=img&make=toyota&modelFamily=${car.model.toLowerCase().replace(/\s+/g, '-')}&zoomType=fullscreen&modelYear=${car.year}&angle=01&width=800&paintId=pspc0130`;
                
                // Always show MSRP
                let cardInfo = `<p><strong>MSRP:</strong> $${car.price_usd?.msrp_from?.toLocaleString() || 'N/A'}</p>`;
                
                // Build additional factor details based on what user requested
                topFactors.forEach(factor => {
                    let value = 'N/A';
                    let label = factor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    // Map simplified factor names to JSON field names
                    const factorToJsonField = {
                        'reliability': 'reliability_longevity',
                        'comfort': 'comfort_refinement',
                        'style': 'style_vibe',
                        'all_weather_capability': 'fit_for_climate_roads'
                    };
                    
                    const jsonFieldName = factorToJsonField[factor] || factor;
                    
                    // Map factor to actual car data - checking ALL possible sources
                    if (factor === 'leg_room') {
                        const front = car.legroom_in?.front;
                        const rear = car.legroom_in?.rear;
                        if (front && rear) {
                            value = `Front: ${front}", Rear: ${rear}"`;
                        } else if (front) {
                            value = `Front: ${front}"`;
                        }
                    } else if (factor === 'horsepower') {
                        value = car.horsepower_hp ? `${car.horsepower_hp} HP` : 'N/A';
                        label = 'Horsepower';
                    } else if (factor === 'mpg') {
                        const city = car.mpg?.city;
                        const hwy = car.mpg?.hwy;
                        const combined = car.mpg?.combined;
                        if (city && hwy && combined) {
                            value = `City: ${city}, Highway: ${hwy}, Combined: ${combined}`;
                        } else if (combined) {
                            value = `${combined} combined`;
                        }
                        label = 'MPG';
                    } else if (factor === 'lease') {
                        const leasePrice = car.price_usd?.lease_per_month;
                        if (leasePrice) {
                            value = `$${leasePrice}/month`;
                        }
                        label = 'Lease';
                    } else if (car.buying_factors && car.buying_factors[jsonFieldName]) {
                        // This handles: safety, reliability_longevity, total_cost_to_own, 
                        // practicality, comfort_refinement, tech_convenience, performance_handling,
                        // warranty_support, resale_value, style_vibe, fit_for_climate_roads
                        value = car.buying_factors[jsonFieldName];
                    }
                    
                    if (value !== 'N/A') {
                        cardInfo += `<p><strong>${label}:</strong> ${value}</p>`;
                    }
                });
                
                card.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="${car.year} Toyota ${car.model}"
                         onerror="this.onerror=null; this.src='https://www.cstatic-images.com/stock/1170x1170/47/image-1670616341547.jpg';">
                    <h2>${car.year} Toyota ${car.model}</h2>
                    ${cardInfo}
                    <div class="car-links">
                        <a href="${car.links?.manufacturer || '#'}" target="_blank" onclick="event.stopPropagation();">üìç View on Toyota.com ‚Üí</a>
                        <a href="${car.links?.edmunds || '#'}" target="_blank" onclick="event.stopPropagation();">üìä Edmunds Review ‚Üí</a>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function selectCar(index, event) {
            const card = event.currentTarget;
            
            if (selectedCars.includes(index)) {
                selectedCars = selectedCars.filter(i => i !== index);
                card.classList.remove('selected');
                const badge = card.querySelector('.selection-badge');
                if (badge) badge.remove();
            } else if (selectedCars.length < 2) {
                selectedCars.push(index);
                card.classList.add('selected');
                const badge = document.createElement('div');
                badge.className = 'selection-badge';
                badge.textContent = selectedCars.length;
                card.appendChild(badge);
            }
            
            if (selectedCars.length === 2) {
                setTimeout(() => showComparison(), 400);
            }
        }

        function closeComparison() {
            document.getElementById('comparisonModal').classList.remove('active');
            document.querySelectorAll('.car-card').forEach(card => {
                card.classList.remove('selected');
                const badge = card.querySelector('.selection-badge');
                if (badge) badge.remove();
            });
            selectedCars = [];
        }

        function evaluateFactor(factorText, factorName) {
            if (!factorText || factorText === 'N/A') return 'neutral';
            
            const text = factorText.toLowerCase();
            
            const goodKeywords = ['excellent', 'great', 'strong', 'high', 'best', 'superior', 'top', 'proven', 
                                 'reliable', 'safe', 'efficient', 'advanced', 'exceptional', 'outstanding', 
                                 'comprehensive', 'generous', 'spacious', 'powerful'];
            const poorKeywords = ['poor', 'low', 'weak', 'limited', 'basic', 'minimal', 'lacking', 
                                 'insufficient', 'mediocre', 'subpar', 'cramped', 'tight'];
            
            const goodCount = goodKeywords.filter(word => text.includes(word)).length;
            const poorCount = poorKeywords.filter(word => text.includes(word)).length;
            
            if (goodCount > poorCount && goodCount > 0) return 'good';
            if (poorCount > goodCount && poorCount > 0) return 'poor';
            return 'neutral';
        }

        function showComparison() {
            const car1 = carsData[selectedCars[0]];
            const car2 = carsData[selectedCars[1]];
            
            let comparisonHTML = '<div class="comparison-grid">';
            
            // Car 1
            const img1 = `https://cdn.imagin.studio/getImage?customer=img&make=toyota&modelFamily=${car1.model.toLowerCase().replace(/\s+/g, '-')}&zoomType=fullscreen&modelYear=${car1.year}&angle=01&width=800&paintId=pspc0130`;
            
            // Build card info for car 1
            let card1Info = `<p><strong>MSRP:</strong> $${car1.price_usd?.msrp_from?.toLocaleString() || 'N/A'}</p>`;
            topFactors.forEach(factor => {
                let value = 'N/A';
                let label = factor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Map simplified factor names to JSON field names
                const factorToJsonField = {
                    'reliability': 'reliability_longevity',
                    'comfort': 'comfort_refinement',
                    'style': 'style_vibe',
                    'all_weather_capability': 'fit_for_climate_roads'
                };
                
                const jsonFieldName = factorToJsonField[factor] || factor;
                
                if (factor === 'leg_room') {
                    const front = car1.legroom_in?.front;
                    const rear = car1.legroom_in?.rear;
                    if (front && rear) {
                        value = `Front: ${front}", Rear: ${rear}"`;
                    } else if (front) {
                        value = `Front: ${front}"`;
                    }
                } else if (factor === 'horsepower') {
                    value = car1.horsepower_hp ? `${car1.horsepower_hp} HP` : 'N/A';
                    label = 'Horsepower';
                } else if (factor === 'mpg') {
                    const city = car1.mpg?.city;
                    const hwy = car1.mpg?.hwy;
                    const combined = car1.mpg?.combined;
                    if (city && hwy && combined) {
                        value = `City: ${city}, Highway: ${hwy}, Combined: ${combined}`;
                    } else if (combined) {
                        value = `${combined} combined`;
                    }
                    label = 'MPG';
                } else if (factor === 'lease') {
                    const leasePrice = car1.price_usd?.lease_per_month;
                    if (leasePrice) {
                        value = `$${leasePrice}/month`;
                    }
                    label = 'Lease';
                } else if (car1.buying_factors && car1.buying_factors[jsonFieldName]) {
                    value = car1.buying_factors[jsonFieldName];
                }
                
                if (value !== 'N/A') {
                    card1Info += `<p><strong>${label}:</strong> ${value}</p>`;
                }
            });
            
            comparisonHTML += `
                <div class="comparison-car">
                    <img src="${img1}" 
                         alt="${car1.year} Toyota ${car1.model}"
                         onerror="this.onerror=null; this.src='https://www.cstatic-images.com/stock/1170x1170/47/image-1670616341547.jpg';">
                    <h2>${car1.year} Toyota ${car1.model}</h2>
                    ${card1Info}
                </div>
            `;
            
            // Car 2
            const img2 = `https://cdn.imagin.studio/getImage?customer=img&make=toyota&modelFamily=${car2.model.toLowerCase().replace(/\s+/g, '-')}&zoomType=fullscreen&modelYear=${car2.year}&angle=01&width=800&paintId=pspc0130`;
            
            // Build card info for car 2
            let card2Info = `<p><strong>MSRP:</strong> $${car2.price_usd?.msrp_from?.toLocaleString() || 'N/A'}</p>`;
            topFactors.forEach(factor => {
                let value = 'N/A';
                let label = factor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Map simplified factor names to JSON field names
                const factorToJsonField = {
                    'reliability': 'reliability_longevity',
                    'comfort': 'comfort_refinement',
                    'style': 'style_vibe',
                    'all_weather_capability': 'fit_for_climate_roads'
                };
                
                const jsonFieldName = factorToJsonField[factor] || factor;
                
                if (factor === 'leg_room') {
                    const front = car2.legroom_in?.front;
                    const rear = car2.legroom_in?.rear;
                    if (front && rear) {
                        value = `Front: ${front}", Rear: ${rear}"`;
                    } else if (front) {
                        value = `Front: ${front}"`;
                    }
                } else if (factor === 'horsepower') {
                    value = car2.horsepower_hp ? `${car2.horsepower_hp} HP` : 'N/A';
                    label = 'Horsepower';
                } else if (factor === 'mpg') {
                    const city = car2.mpg?.city;
                    const hwy = car2.mpg?.hwy;
                    const combined = car2.mpg?.combined;
                    if (city && hwy && combined) {
                        value = `City: ${city}, Highway: ${hwy}, Combined: ${combined}`;
                    } else if (combined) {
                        value = `${combined} combined`;
                    }
                    label = 'MPG';
                } else if (factor === 'lease') {
                    const leasePrice = car2.price_usd?.lease_per_month;
                    if (leasePrice) {
                        value = `$${leasePrice}/month`;
                    }
                    label = 'Lease';
                } else if (car2.buying_factors && car2.buying_factors[jsonFieldName]) {
                    value = car2.buying_factors[jsonFieldName];
                }
                
                if (value !== 'N/A') {
                    card2Info += `<p><strong>${label}:</strong> ${value}</p>`;
                }
            });
            
            comparisonHTML += `
                <div class="comparison-car">
                    <img src="${img2}" 
                         alt="${car2.year} Toyota ${car2.model}"
                         onerror="this.onerror=null; this.src='https://www.cstatic-images.com/stock/1170x1170/47/image-1670616341547.jpg';">
                    <h2>${car2.year} Toyota ${car2.model}</h2>
                    ${card2Info}
                </div>
            `;
            
            // Legend
            comparisonHTML += `
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color good"></div>
                        <span><strong>Green:</strong> Strongly matches your requirements</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color neutral"></div>
                        <span><strong>Gray:</strong> Average or similar between cars</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color poor"></div>
                        <span><strong>Red:</strong> Does not match well</span>
                    </div>
                </div>
            `;
            
            // Title for specified factors
            comparisonHTML += '<div class="factors-section-title">üìã Comparison Based on Your Specifications</div>';
            
            // Compare top 3 factors with intelligent comparison
            topFactors.forEach(factor => {
                let val1 = 'N/A';
                let val2 = 'N/A';
                
                // Map simplified factor names to JSON field names
                const factorToJsonField = {
                    'reliability': 'reliability_longevity',
                    'comfort': 'comfort_refinement',
                    'style': 'style_vibe',
                    'all_weather_capability': 'fit_for_climate_roads'
                };
                
                const jsonFieldName = factorToJsonField[factor] || factor;
                
                // Get values based on factor type
                if (factor === 'leg_room') {
                    const front1 = car1.legroom_in?.front;
                    const rear1 = car1.legroom_in?.rear;
                    const front2 = car2.legroom_in?.front;
                    const rear2 = car2.legroom_in?.rear;
                    
                    if (front1 && rear1) {
                        val1 = `Front: ${front1}", Rear: ${rear1}"`;
                    } else if (front1) {
                        val1 = `Front: ${front1}"`;
                    }
                    
                    if (front2 && rear2) {
                        val2 = `Front: ${front2}", Rear: ${rear2}"`;
                    } else if (front2) {
                        val2 = `Front: ${front2}"`;
                    }
                } else if (factor === 'horsepower') {
                    val1 = car1.horsepower_hp ? `${car1.horsepower_hp} HP` : 'N/A';
                    val2 = car2.horsepower_hp ? `${car2.horsepower_hp} HP` : 'N/A';
                } else if (factor === 'mpg') {
                    const city1 = car1.mpg?.city;
                    const hwy1 = car1.mpg?.hwy;
                    const combined1 = car1.mpg?.combined;
                    const city2 = car2.mpg?.city;
                    const hwy2 = car2.mpg?.hwy;
                    const combined2 = car2.mpg?.combined;
                    
                    if (city1 && hwy1 && combined1) {
                        val1 = `City: ${city1}, Highway: ${hwy1}, Combined: ${combined1}`;
                    } else if (combined1) {
                        val1 = `${combined1} combined`;
                    }
                    
                    if (city2 && hwy2 && combined2) {
                        val2 = `City: ${city2}, Highway: ${hwy2}, Combined: ${combined2}`;
                    } else if (combined2) {
                        val2 = `${combined2} combined`;
                    }
                } else if (factor === 'lease') {
                    const lease1 = car1.price_usd?.lease_per_month;
                    const lease2 = car2.price_usd?.lease_per_month;
                    
                    if (lease1) {
                        val1 = `$${lease1}/month`;
                    }
                    
                    if (lease2) {
                        val2 = `$${lease2}/month`;
                    }
                } else if (car1.buying_factors && car1.buying_factors[jsonFieldName]) {
                    // All buying_factors: safety, reliability_longevity, total_cost_to_own, etc.
                    val1 = car1.buying_factors[jsonFieldName] || 'N/A';
                    val2 = car2.buying_factors[jsonFieldName] || 'N/A';
                }
                
                // Check if the values are identical or very similar
                const areSimilar = val1 === val2 || 
                                   (val1 !== 'N/A' && val2 !== 'N/A' && val1.toLowerCase().trim() === val2.toLowerCase().trim());
                
                // Create unique comparison text
                const comparison1 = generateComparisonText(car1, car2, factor, val1, val2, true);
                const comparison2 = generateComparisonText(car2, car1, factor, val2, val1, false);
                
                // Smart rating based on numeric comparison for numeric factors
                let rating1 = 'neutral';
                let rating2 = 'neutral';
                
                if (factor === 'horsepower') {
                    // Extract numeric values
                    const hp1 = car1.horsepower_hp;
                    const hp2 = car2.horsepower_hp;
                    
                    if (hp1 && hp2) {
                        const diff = Math.abs(hp1 - hp2);
                        // Only color if difference is significant (more than 20 HP)
                        if (diff > 20) {
                            rating1 = hp1 > hp2 ? 'good' : 'poor';
                            rating2 = hp2 > hp1 ? 'good' : 'poor';
                        }
                    }
                } else if (factor === 'mpg') {
                    // Extract combined MPG for comparison
                    const mpg1 = car1.mpg?.combined;
                    const mpg2 = car2.mpg?.combined;
                    
                    if (mpg1 && mpg2) {
                        const diff = Math.abs(mpg1 - mpg2);
                        // Only color if difference is significant (more than 3 MPG)
                        if (diff > 3) {
                            rating1 = mpg1 > mpg2 ? 'good' : 'poor';
                            rating2 = mpg2 > mpg1 ? 'good' : 'poor';
                        }
                    }
                } else if (factor === 'leg_room') {
                    // Extract front leg room for comparison
                    const leg1 = car1.legroom_in?.front;
                    const leg2 = car2.legroom_in?.front;
                    
                    if (leg1 && leg2) {
                        const diff = Math.abs(leg1 - leg2);
                        // Only color if difference is significant (more than 1 inch)
                        if (diff > 1) {
                            rating1 = leg1 > leg2 ? 'good' : 'poor';
                            rating2 = leg2 > leg1 ? 'good' : 'poor';
                        }
                    }
                } else if (factor === 'total_cost_to_own') {
                    // Extract MSRP for cost comparison
                    const price1 = car1.price_usd?.msrp_from;
                    const price2 = car2.price_usd?.msrp_from;
                    
                    if (price1 && price2) {
                        const diff = Math.abs(price1 - price2);
                        // Only color if difference is significant (more than $2000)
                        if (diff > 2000) {
                            // Lower price is better (good), higher price is worse (poor)
                            rating1 = price1 < price2 ? 'good' : 'poor';
                            rating2 = price2 < price1 ? 'good' : 'poor';
                        }
                    }
                } else if (factor === 'lease') {
                    // Extract lease price for comparison
                    const lease1 = car1.price_usd?.lease_per_month;
                    const lease2 = car2.price_usd?.lease_per_month;
                    
                    if (lease1 && lease2) {
                        const diff = Math.abs(lease1 - lease2);
                        // Only color if difference is significant (more than $30/month)
                        if (diff > 30) {
                            // Lower lease payment is better (good), higher is worse (poor)
                            rating1 = lease1 < lease2 ? 'good' : 'poor';
                            rating2 = lease2 < lease1 ? 'good' : 'poor';
                        }
                    }
                } else {
                    // For text factors, use the existing evaluation
                    rating1 = areSimilar ? 'neutral' : evaluateFactor(val1, factor);
                    rating2 = areSimilar ? 'neutral' : evaluateFactor(val2, factor);
                }
                
                // Format factor label properly
                const factorLabel = factor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                comparisonHTML += `
                    <div class="factor-row ${rating1}">
                        <div class="factor-label">${factorLabel}</div>
                        <div class="factor-value">${comparison1}</div>
                    </div>
                    <div class="factor-row ${rating2}">
                        <div class="factor-label">${factorLabel}</div>
                        <div class="factor-value">${comparison2}</div>
                    </div>
                `;
            });
            
            // Add Financing Information Section
            if (car1.financing_75080 && car2.financing_75080) {
                comparisonHTML += `
                    <div class="financing-section" style="opacity: 0;">
                        <div class="financing-title">üí∞ Financing Options Near You (75080)</div>
                        <div class="financing-subtitle">Compare pricing from 3 Toyota dealerships in the Richardson, TX area</div>
                        
                        <div class="financing-grid">
                            <!-- Car 1 Financing -->
                            <div class="financing-car">
                                <h3>${car1.year} ${car1.model}</h3>
                                ${generateFinancingHTML(car1.financing_75080)}
                            </div>
                            
                            <!-- Car 2 Financing -->
                            <div class="financing-car">
                                <h3>${car2.year} ${car2.model}</h3>
                                ${generateFinancingHTML(car2.financing_75080)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            comparisonHTML += '</div>';
            
            document.getElementById('comparisonGrid').innerHTML = comparisonHTML;
            document.getElementById('comparisonModal').classList.add('active');
            
            // Fade in financing section after a delay
            setTimeout(() => {
                const financingSection = document.querySelector('.financing-section');
                if (financingSection) {
                    financingSection.style.transition = 'opacity 1.5s ease-in';
                    financingSection.style.opacity = '1';
                }
            }, 500);
        }
        
        function generateFinancingHTML(financing) {
            let html = '';
            
            // Best Deal Summary
            html += `
                <div class="best-deal-box">
                    <div class="best-deal-title">üèÜ Best Deals</div>
                    <div class="best-deal-item">
                        <strong>Lowest Monthly:</strong> $${financing.best_deal_summary.lowest_monthly_payment.amount}/mo 
                        <span class="dealer-name">(${financing.best_deal_summary.lowest_monthly_payment.dealership})</span>
                    </div>
                    <div class="best-deal-item">
                        <strong>Best APR:</strong> ${financing.best_deal_summary.best_apr.rate}%
                        <span class="dealer-name">(${financing.best_deal_summary.best_apr.dealership})</span>
                    </div>
                    <div class="best-deal-item">
                        <strong>Lowest Total:</strong> $${financing.best_deal_summary.lowest_total_cost.amount.toLocaleString()}
                        <span class="dealer-name">(${financing.best_deal_summary.lowest_total_cost.dealership})</span>
                    </div>
                </div>
            `;
            
            // Dealership Details
            financing.dealerships.forEach((dealer, idx) => {
                html += `
                    <div class="dealer-card">
                        <div class="dealer-header">
                            <div class="dealer-name-main">${dealer.name}</div>
                            <div class="dealer-distance">${dealer.distance_miles} mi away</div>
                        </div>
                        <div class="dealer-address">${dealer.address}</div>
                        <div class="dealer-phone">üìû ${dealer.phone}</div>
                        
                        <div class="finance-tabs">
                            <div class="finance-tab">
                                <div class="tab-title">Purchase Financing</div>
                                <div class="credit-tier">
                                    <strong>Excellent Credit (720+):</strong>
                                    <div class="tier-details">
                                        ${dealer.finance_options.purchase.apr_tiers.tier_1_excellent.apr}% APR ‚Ä¢ 
                                        $${dealer.finance_options.purchase.apr_tiers.tier_1_excellent.monthly_payment}/mo ‚Ä¢ 
                                        60 months
                                    </div>
                                </div>
                                <div class="credit-tier">
                                    <strong>Good Credit (680-719):</strong>
                                    <div class="tier-details">
                                        ${dealer.finance_options.purchase.apr_tiers.tier_2_good.apr}% APR ‚Ä¢ 
                                        $${dealer.finance_options.purchase.apr_tiers.tier_2_good.monthly_payment}/mo ‚Ä¢ 
                                        60 months
                                    </div>
                                </div>
                                <div class="price-note">
                                    Price: $${dealer.finance_options.purchase.price_after_incentives.toLocaleString()} 
                                    (Down: $${dealer.finance_options.purchase.down_payment.toLocaleString()})
                                </div>
                            </div>
                            
                            <div class="finance-tab lease-tab">
                                <div class="tab-title">Lease Option</div>
                                <div class="lease-highlight">
                                    $${dealer.finance_options.lease.monthly_payment}/mo
                                </div>
                                <div class="lease-details">
                                    ${dealer.finance_options.lease.term_months} months ‚Ä¢ 
                                    ${dealer.finance_options.lease.annual_mileage.toLocaleString()} mi/year<br>
                                    Due at signing: $${dealer.finance_options.lease.due_at_signing.toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Annual Ownership Costs
            html += `
                <div class="ownership-costs">
                    <div class="costs-title">üìä Estimated Annual Costs</div>
                    <div class="cost-grid">
                        <div class="cost-item">
                            <span>Insurance:</span>
                            <strong>$${financing.yearly_cost_estimates.insurance_annual.toLocaleString()}</strong>
                        </div>
                        <div class="cost-item">
                            <span>Registration:</span>
                            <strong>$${financing.yearly_cost_estimates.registration_annual.toLocaleString()}</strong>
                        </div>
                        <div class="cost-item">
                            <span>Maintenance:</span>
                            <strong>$${financing.yearly_cost_estimates.maintenance_annual.toLocaleString()}</strong>
                        </div>
                        <div class="cost-item">
                            <span>Fuel (12K mi):</span>
                            <strong>$${financing.yearly_cost_estimates.fuel_annual_12k_miles.toLocaleString()}</strong>
                        </div>
                        <div class="cost-item total-cost">
                            <span>Total Annual:</span>
                            <strong>$${financing.yearly_cost_estimates.total_annual_ownership.toLocaleString()}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateComparisonText(car1, car2, factor, val1, val2, isFirst) {
            if (val1 === 'N/A') return 'N/A';
            
            // Extract specific data points for intelligent comparison
            const year1 = car1.year;
            const year2 = car2.year;
            const model1 = car1.model;
            const model2 = car2.model;
            const price1 = car1.price_usd?.msrp_from;
            const price2 = car2.price_usd?.msrp_from;
            const mpg1 = car1.mpg?.combined;
            const mpg2 = car2.mpg?.combined;
            
            // Check if values are essentially the same
            const areSimilar = val1.toLowerCase().trim() === val2.toLowerCase().trim();
            
            // Create contextual, unique comparison for each car
            let comparison = '';
            
            if (factor === 'efficiency_range') {
                if (mpg1 && mpg2) {
                    const diff = mpg1 - mpg2;
                    if (areSimilar || Math.abs(diff) <= 3) {
                        // Similar MPG - make unique for each car
                        comparison = `The ${year1} ${model1} delivers ${mpg1} MPG combined`;
                        if (val1.toLowerCase().includes('excellent')) {
                            comparison += ', offering excellent fuel economy';
                        } else if (val1.toLowerCase().includes('competitive')) {
                            comparison += ', providing competitive efficiency';
                        }
                        comparison += ` for its class.`;
                    } else if (diff > 0) {
                        comparison = `The ${year1} ${model1} achieves ${mpg1} MPG combined, ${diff} MPG better than the ${model2}, giving it a notable fuel economy advantage.`;
                    } else {
                        comparison = `The ${year1} ${model1} gets ${mpg1} MPG combined, which is ${Math.abs(diff)} MPG less efficient than the ${model2}.`;
                    }
                }
            } else if (factor === 'total_cost_to_own') {
                if (price1 && price2) {
                    const diff = price1 - price2;
                    const monthlyLease1 = car1.price_usd?.lease_per_month;
                    const monthlyLease2 = car2.price_usd?.lease_per_month;
                    
                    if (areSimilar || Math.abs(diff) <= 2500) {
                        // Similar cost - make unique for each car
                        comparison = `The ${year1} ${model1} starts at $${price1.toLocaleString()} (approx. $${monthlyLease1}/mo lease). `;
                        if (val1.toLowerCase().includes('low fuel')) {
                            comparison += `Low fuel and maintenance costs help keep total ownership expenses manageable.`;
                        } else if (val1.toLowerCase().includes('outstanding fuel savings')) {
                            comparison += `Outstanding fuel savings significantly reduce long-term operating costs.`;
                        } else {
                            comparison += `Reasonable insurance and strong residuals contribute to solid value retention.`;
                        }
                    } else if (diff < 0) {
                        comparison = `The ${year1} ${model1} starts at $${price1.toLocaleString()}, which is $${Math.abs(diff).toLocaleString()} less than the ${model2}, making it the more affordable option with lower entry cost.`;
                    } else {
                        comparison = `The ${year1} ${model1} is priced at $${price1.toLocaleString()}, $${diff.toLocaleString()} more than the ${model2}, positioning it as a premium choice in the lineup.`;
                    }
                }
            } else if (factor === 'safety') {
                const hasTSS = val1.toLowerCase().includes('tss');
                const version1 = val1.match(/tss[- ]?p|tss[- ]?2\.0|tss[- ]?c/i)?.[0] || 'TSS';
                
                if (areSimilar) {
                    // Same safety features - make unique descriptions
                    comparison = `The ${year1} ${model1} `;
                    if (hasTSS) {
                        if (val1.includes('standard')) {
                            comparison += `comes standard with Toyota Safety Sense (${version1})`;
                        } else {
                            comparison += `features ${version1}`;
                        }
                        comparison += `, providing comprehensive driver assistance including AEB, LKA, and BSM for enhanced protection.`;
                    } else {
                        comparison += `includes basic safety features with available advanced options on higher trims.`;
                    }
                } else if (year1 > year2) {
                    comparison = `The ${year1} ${model1} benefits from updated safety technology. ${val1}`;
                } else {
                    comparison = `The ${year1} ${model1}: ${val1}`;
                }
            } else if (factor === 'reliability_longevity') {
                const isHybrid1 = car1.variant?.toLowerCase().includes('hybrid') || model1.toLowerCase().includes('hybrid');
                const isHybrid2 = car2.variant?.toLowerCase().includes('hybrid') || model2.toLowerCase().includes('hybrid');
                
                if (areSimilar) {
                    // Same reliability - make unique
                    if (isHybrid1) {
                        comparison = `The ${year1} ${model1} features Toyota's proven hybrid powertrain with a strong track record for durability and minimal maintenance requirements over time.`;
                    } else {
                        comparison = `The ${year1} ${model1} utilizes Toyota's reliable gas powertrain, known for simple upkeep and extended service life with proper maintenance.`;
                    }
                } else {
                    comparison = `${model1} (${year1}): ${val1}`;
                }
            } else if (factor === 'practicality') {
                const legroom1 = car1.legroom_in?.rear;
                const legroom2 = car2.legroom_in?.rear;
                
                if (areSimilar && legroom1 && legroom2) {
                    const diff = Math.abs(legroom1 - legroom2);
                    if (diff <= 2) {
                        comparison = `The ${year1} ${model1} provides ${legroom1}" of rear legroom`;
                        if (val1.toLowerCase().includes('roomy')) {
                            comparison += ', offering spacious seating for passengers';
                        } else if (val1.toLowerCase().includes('flexible')) {
                            comparison += ', along with flexible cargo space';
                        } else {
                            comparison += ', suitable for daily use';
                        }
                        comparison += '.';
                    } else if (legroom1 > legroom2) {
                        comparison = `The ${year1} ${model1} offers ${legroom1}" rear legroom, ${diff.toFixed(1)}" more spacious than the ${model2}.`;
                    } else {
                        comparison = `The ${year1} ${model1} has ${legroom1}" rear legroom, ${diff.toFixed(1)}" less than the ${model2}'s interior space.`;
                    }
                } else {
                    comparison = `${model1} (${year1}): ${val1}`;
                }
            } else {
                // Default: Add context about the specific car
                comparison = `${model1} (${year1}): ${val1}`;
            }
            
            return comparison;
        }
        

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
